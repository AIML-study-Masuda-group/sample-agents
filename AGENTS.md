# AGENTS.md

Speak in Japanese.

このドキュメントは、Claude Code、GitHub Copilot、Codex などの生成AIエージェントがプロジェクトで作業する際の共通ガイドラインです。

## ドキュメントの役割
- `README.md`: プロジェクト全体の概要とクイックスタート（人とAIの共通入口）
- `PLAN.md`: 実装計画書（目標、システム構成、実装フェーズ）
- `CONTRIBUTING.md`: 人が主体で運用する開発フローとレビュープロセス
- `RUNBOOK.md`: 恒久ルールと運用手順の一次情報（**必ず遵守**）
- `CLAUDE.md`: Claude Code 固有の補足。Claude 以外のエージェントも内容を参考にしてよい
- `.github/copilot-instructions.md`: GitHub Copilot 固有のインストラクション

## 共通原則

### 1. 人間のオーナーシップを尊重する
- 意思決定の前提に不明点があれば必ず確認する
- 複数の選択肢がある場合は、トレードオフを説明して人に判断を仰ぐ
- 破壊的な操作（リソース削除、本番デプロイなど）は明示的な指示がある場合のみ実行

### 2. RUNBOOK を最優先で遵守する
- 作業開始前に RUNBOOK.md を必ず読む
- RUNBOOK に書かれていない恒久ルールを導入する前に「RUNBOOK.md に追記しますか？」と質問する
- RUNBOOK と矛盾する独自ルールを追加しない

### 3. PLAN を理解して作業する
- 実装開始前に PLAN.md を読み、プロジェクトの目標と実装フェーズを理解する
- 現在どのフェーズにいるか確認し、段階的に実装を進める
- フェーズ間の依存関係を意識して作業する

### 4. 変更履歴と意図を明確に残す
- 変更は原則 Pull Request 経由で共有する
- コミットメッセージは日本語で、目的と影響が分かるように記述する
- PR には背景・変更内容・テスト結果・影響範囲を必ず記載する

### 5. セキュリティとデータ保護
- 秘密情報（鍵・トークン・個人情報）をリポジトリへ保存しない
- 認証情報は Secret Manager や環境変数で管理する
- `.gitignore` を確認し、秘匿情報が含まれないようにする

### 6. ツールバージョンを統一する
- コマンド実行は `mise run ...` に統一し、mise で管理されたツールを使用する
- カスタム操作が必要な場合は事前に理由を共有し、mise タスクへの追加を検討する
- 直接コマンドを実行すると、異なるバージョンが使われる可能性があるため避ける

### 7. ドキュメントを常に最新に保つ
- コード変更がドキュメントに影響する場合は、対応するドキュメントも同時に更新する
- 更新が必要なドキュメントが不明な場合は人に確認する
- PR には「以下のドキュメントを更新しました」とリストアップして共有する

## 作業プロセス

### 準備フェーズ
1. `README.md` の「クイックスタート」で環境を整える
2. `mise install` を実行し、必要なツールをインストールする
3. `PLAN.md` を読み、プロジェクトの目標と現在のフェーズを理解する
4. `RUNBOOK.md` を読み、恒久ルールと標準ワークフローを確認する

### 開発フェーズ
1. **作業前の確認**
   - PLAN.md で現在のフェーズと実装すべき機能を確認
   - RUNBOOK.md の「標準ワークフロー」に従って作業を進める
   - 不明点や判断が必要な事項は人に確認する

2. **実装**
   - コードを書く際は、既存のコーディング規約に従う
   - テストコードも同時に作成する
   - ドキュメントに影響がある場合は同時に更新する

3. **検証**
   - RUNBOOK の「リリースチェックリスト」を満たすまで進めない
   - テストを実行し、すべてパスすることを確認する
   - 影響範囲を確認し、想定外の変更がないかチェックする

### ハンドオフフェーズ
1. **PR作成**
   - 背景・変更内容・テスト結果・影響範囲を記載する
   - 更新したドキュメントをリストアップする
   - ロールバック方法を簡潔にまとめる

2. **レビュー対応**
   - レビューコメントに対して丁寧に回答する
   - 修正が必要な場合は速やかに対応する
   - 合意が得られない場合は、複数案とトレードオフを提示する

## コミュニケーション
- 仕様の曖昧さや判断が必要な事項は複数案とトレードオフを提示して相談する
- 進行中に想定外の変更や失敗が発生した場合は即時報告し、勝手な巻き戻しや強制 push をしない
- Runbook の更新依頼を受けて実施した場合は、更新箇所をメモして人のレビュアーへ共有する

## ドキュメント更新の原則

Terraform 構成の変更を行った際は、対応するドキュメントも同時に更新することを徹底します。

### 更新が必要な場合の判断基準

以下のような変更を行った場合は、必ずドキュメント更新の必要性を確認してください：

#### 1. インフラ構成の変更
- **影響を受けるドキュメント:**
  - `README.md`
  - `RUNBOOK.md`
- **変更例:**
  - 新しい GCP リソースの追加（予算、通知チャネル、Pub/Sub など）
  - モジュール構造の変更
  - 環境（dev/stg/prd）の追加・削除

#### 2. 設定パラメータの変更
- **影響を受けるドキュメント:**
  - `RUNBOOK.md`
  - Terraform の README（terraform/README.md が存在する場合）
- **変更例:**
  - 予算しきい値の変更
  - 通知先の追加・変更
  - 環境変数やシークレットの変更

#### 3. 運用手順の変更
- **影響を受けるドキュメント:**
  - `RUNBOOK.md`
  - `CONTRIBUTING.md`
- **変更例:**
  - Terraform 実行手順の変更
  - デプロイフローの変更
  - 権限設定の変更

#### 4. ツールやバージョンの更新
- **影響を受けるドキュメント:**
  - `README.md`
  - `RUNBOOK.md`
  - `mise.toml`
- **変更例:**
  - Terraform バージョンの変更
  - 新しいツールの導入
  - GCP API の追加

### ドキュメント更新の手順

1. **変更前に確認**: 「この変更はドキュメントに影響しますか？」と自問する
2. **影響範囲の特定**: 上記の判断基準を参考に、更新が必要なドキュメントをリストアップ
3. **ドキュメント更新の実施**: コード変更と同じ PR 内でドキュメントも更新
4. **人への確認**: 不明な場合は「ドキュメント更新が必要ですか？どのドキュメントを更新すべきですか？」と質問
5. **PR に記載**: 「以下のドキュメントを更新しました」とリストアップして共有

### ドキュメント更新のチェックリスト

コード変更の PR を作成する前に、以下を確認してください：

- [ ] インフラ構成に変更がある場合、README.md と RUNBOOK.md を更新したか
- [ ] 新しい運用ルールを導入した場合、RUNBOOK.md や CONTRIBUTING.md に反映したか
- [ ] ツールやバージョンに変更がある場合、README.md と mise.toml を更新したか
- [ ] 更新したドキュメントの内容が一貫しているか（矛盾がないか）

### ドキュメントマップ

主要なドキュメントと用途：

| ドキュメント | 用途 | 更新タイミング |
|------------|------|--------------|
| `README.md` | プロジェクト概要、クイックスタート | 前提条件・セットアップ手順の変更時 |
| `RUNBOOK.md` | 恒久ルール、標準ワークフロー | ワークフロー・運用ルールの変更時 |
| `CONTRIBUTING.md` | 開発フロー、レビュープロセス | Git・PR プロセスの変更時 |
| `mise.toml` | ツールバージョン管理 | ツール・バージョンの変更時 |

## コミュニケーション

### 確認が必要な場合
- 仕様の曖昧さや判断が必要な事項は複数案とトレードオフを提示して相談する
- 新しい恒久ルールが必要になった場合は「RUNBOOK.md に追記しますか？」と確認する
- 想定外のエラーや問題が発生した場合は即時報告する

### 報告の仕方
- **背景**: なぜこの問題が発生したか
- **現状**: 現在どのような状態か
- **提案**: どのように解決すべきか（複数案を提示）
- **影響**: この問題が他に与える影響

### 進捗の共有
- フェーズ単位で進捗を報告する
- 完了したタスク、進行中のタスク、ブロッカーを明確にする
- RUNBOOK や PLAN の更新が必要な場合は提案する

## 禁止事項

### 絶対にしてはいけないこと
1. **人の承認なく破壊的な操作を実行しない**
   - 本番環境へのデプロイ（`mise run tf:apply` など）
   - リソースの削除
   - データベースのマイグレーション
   - force push や rebase など Git 履歴を変更する操作

2. **秘密情報を含めない**
   - 認証情報（APIキー、パスワード、トークン）を生成ファイルに含めない
   - 秘密情報をコミットメッセージやコメントに含めない
   - `.gitignore` を確認し、秘匿情報が含まれないようにする

3. **独自ルールを追加しない**
   - RUNBOOK と矛盾する独自ルールを追加しない
   - 新しいルールが必要な場合は人に確認し、RUNBOOK に追記する

4. **勝手な巻き戻しをしない**
   - エラーが発生しても、勝手に `git reset --hard` や `git push --force` をしない
   - 問題を報告し、人の判断を仰ぐ
